<div
    class="relative flex flex-col flex-auto shrink-0 lg:shrink p-3 lg:overflow-y-auto bg-gray-100 dark:bg-transparent min-h-0"
    fuseScrollReset>
    <!-- Main -->
    <div
        class="absolute inset-0 flex flex-col flex-0 shadow overflow-hidden bg-card dark:bg-black dark:bg-opacity-10 min-h-0">
        <!-- Invoice -->
        <div
            class="min-w-240 p-3 shadow bg-card print:w-auto print:p-0 print:rounded-none print:shadow-none print:bg-transparent overflow-y-auto">
            <div *ngIf="!payment.collaborator" class="flex items-start">
                <div class="grid grid-cols-max w-6/12 place-items-start gap-y-2">
                    <mat-form-field class="example-full-width w-full" appearance="fill">
                        <mat-label for="status">Search Collaborator</mat-label>
                        <input
                            type="text"
                            class="form-control font-bold w-full"
                            placeholder="Collaborator"
                            aria-label="Collaborator"
                            matInput
                            [formControl]="collaboratorControl"
                            [matAutocomplete]="auto1" />
                        <mat-autocomplete #auto1="matAutocomplete" (optionSelected)="onSelectedCollaborator($event)">
                            <mat-option
                                class="form-control font-bold"
                                *ngFor="let option of filteredCollaborators | async"
                                [value]="option">
                                <div class="option-container">
                                    <div class="option-name">{{ option.companyName }}</div>
                                    <div class="option-email">{{ option.address }} {{ option.city }}</div>
                                </div>
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                </div>
                <div *ngIf="!payment.collaborator" class="grid grid-cols-max w-6/12 place-items-end gap-y-2 mr-5">
                    <years-toggle
                        [number]="5"
                        [currentYear]="currentYear"
                        (yearChange)="onYearChange($event)"></years-toggle>

                    <div class="grid grid-cols-2 gap-x-4 text-right">
                        <div class="text-gray-600">Collaboratori da pagare:</div>
                        <div class="font-semibold">{{ countCollaboratorsToBePaid }}</div>
                        <div class="text-gray-600">Totale servizi:</div>
                        <div class="font-semibold">{{ totalServiceCount }}</div>
                        <div class="text-gray-600">Totale da pagare:</div>
                        <div class="font-semibold">€ {{ totalPaymentAmount | number: '2.2' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div *ngIf="!payment.collaborator" class="w-full h-full mt-10 rounded-2xl shadow-lg overflow-visible">
        <div class="flex flex-col h-full">
            <mat-icon class="text-6xl text-gray-400 mb-4" [svgIcon]="'mat_solid:payments'"></mat-icon>

            <div class="flex flex-col h-full">
                <!-- Intestazione colonne fissa -->
                <div class="flex-none bg-gray-50 dark:bg-gray-800 border-b">
                    <div class="grid grid-cols-12 gap-x-1 gap-y-1 px-2 py-2">
                        <div class="col-span-9 font-medium text-md text-secondary">COLLABORATOR</div>
                        <div class="col-span-1 font-medium text-md text-right text-secondary">SERIVCES</div>
                        <div class="col-span-2 font-medium text-md text-right text-secondary">TOTAL</div>
                    </div>
                </div>

                <!-- Area scrollabile con gli items -->
                <div class="flex-1 overflow-y-auto min-h-0 relative">
                    <div class="absolute inset-0 px-2 py-2 overflow-y-auto">
                        <ng-container *ngFor="let item of collaboratorsToBePaid; let i = index; trackBy: trackByFn">
                            <div
                                (dblclick)="setCollaborator(item.collaborator)"
                                [class]="i % 2 === 0 ? 'bg-white' : 'bg-gray-300'"
                                class="grid grid-cols-12 gap-x-1 gap-y-2 items-center p-2 hover:bg-gray-500 hover:font-bold hover:text-white cursor-pointer">
                                <div class="col-span-9 flex items-start">
                                    <span>{{ item.collaborator.code }} - {{ item.collaborator.fullName }}</span>
                                </div>
                                <div class="col-span-1 self-center text-right">{{ item.serviceCount }}</div>
                                <div class="col-span-2 self-center text-right">
                                    € {{ item.totalAmount | number: '2.2' }}
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <mat-drawer-container *ngIf="payment.collaborator" class="w-full h-full rounded-2xl shadow-lg overflow-visible">
        <mat-drawer-content class="h-full min-h-0">
            <!-- Pulsante icona per aprire/chiudere il drawer -->
            <button mat-icon-button (click)="drawer.toggle()" class="absolute top-4 right-4 z-10">
                <mat-icon>{{ drawer.opened ? 'chevron_right' : 'chevron_left' }}</mat-icon>
            </button>
            <!-- Dettagli paymento -->
            <div class="flex flex-col h-full">
                <!-- Azioni -->
                <div class="flex items-start gap-2 bg-white w-full">
                    <button class="flex space-x-2" mat-flat-button color="warn" (click)="resetCollaborator()">
                        <mat-icon class="icon-size-5 mr-2" [svgIcon]="'mat_solid:cancel'"></mat-icon>
                        <span>{{ 'General.Abort' | transloco }}</span>
                    </button>
                    <button class="flex space-x-2" mat-flat-button color="primary" (click)="save()">
                        <mat-icon class="icon-size-5 mr-2" [svgIcon]="'mat_solid:save'"></mat-icon>
                        <span>{{ 'General.Save' | transloco }}</span>
                    </button>
                </div>

                <!-- Header fisso -->
                <div class="flex-none p-3 bg-white dark:bg-gray-900 border-b">
                    <h2 class="text-2xl font-bold mb-4">Pay To</h2>
                    <div class="flex gap-4 w-full">
                        <div class="w-8/12">
                            <div>
                                <span class="font-semibold">{{ payment.collaborator?.displayName }}</span>
                            </div>
                            <div>
                                <span class="font-semibold">{{ payment.collaborator?.address }}</span>
                            </div>
                            <div>
                                <span class="font-semibold"
                                    >{{ payment.collaborator?.cap }} - {{ payment.collaborator?.city }}</span
                                >
                            </div>
                            <div>
                                <span class="font-semibold">{{ payment.collaborator?.fiscalCode }}</span>
                            </div>
                            <div>
                                <span class="font-semibold">{{ payment.collaborator?.taxCode }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="w-full grid grid-cols-4 gap-4 mb-2 mt-4">
                        <div class="flex flex-col">
                            <span class="font-semibold text-left mb-2">Data:</span>
                            <mat-form-field appearance="outline" class="w-full m-0">
                                <input matInput [matDatepicker]="picker2" [(ngModel)]="payment.date" />
                                <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
                                <mat-datepicker #picker2></mat-datepicker>
                            </mat-form-field>
                        </div>
                        <div class="flex flex-col">
                            <span class="font-semibold text-left mb-2">Numero:</span>
                            <mat-form-field appearance="outline" class="w-full m-0">
                                <input matInput [(ngModel)]="payment.number" type="number" step="1" />
                                <mat-hint class="m-0 p-0">Se vuoto, numerazione automatica</mat-hint>
                            </mat-form-field>
                        </div>
                        <div class="flex flex-col">
                            <span class="font-semibold text-left mb-2">Iva %:</span>
                            <mat-form-field appearance="outline" class="w-full m-0">
                                <input matInput [(ngModel)]="payment.vatRate" type="number" step="0.1" />
                            </mat-form-field>
                        </div>
                        <div class="flex flex-col">
                            <span class="font-semibold text-left mb-2">Ritenuta d'acconto %:</span>
                            <mat-form-field appearance="outline" class="w-full m-0">
                                <input matInput [(ngModel)]="payment.withholdingTaxRate" type="number" step="0.1" />
                            </mat-form-field>
                        </div>
                    </div>
                    <div class="w-full grid grid-cols-12 gap-4 mb-2 mt-4">
                        <div class="flex flex-col col-span-12">
                            <span class="font-semibold text-left mb-2">Note:</span>
                            <mat-form-field appearance="outline" class="w-full m-0">
                                <textarea matInput [(ngModel)]="payment.notes" rows="3"></textarea>
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <!-- Intestazione colonne fissa -->
                <div class="flex-none bg-gray-50 dark:bg-gray-800 border-b">
                    <div class="grid grid-cols-12 gap-x-1 px-8 py-4">
                        <div class="col-span-4 font-medium text-md text-secondary">CLIENT</div>
                        <div class="col-span-7 font-medium text-md text-secondary">SERVICE</div>
                        <div class="col-span-1 font-medium text-md text-right text-secondary">COMMISSION</div>
                    </div>
                </div>

                <!-- Area scrollabile con gli items -->
                <div class="flex-1 overflow-y-auto min-h-0 relative">
                    <div class="absolute inset-0 px-8 py-4 overflow-y-auto">
                        <div
                            cdkDropList
                            [cdkDropListData]="payment.items"
                            (cdkDropListDropped)="dropPaymentItem($event)"
                            class="w-full">
                            <ng-container *ngFor="let item of payment?.items; trackBy: trackByFn">
                                <!-- Divider -->
                                <div class="col-span-12 my-4 border-b"></div>
                                <!-- Item: ogni campo in una colonna -->
                                <div
                                    cdkDrag
                                    class="grid grid-cols-12 gap-x-1 items-center"
                                    [class.font-bold]="selectedItem && selectedItem.id === item.id">
                                    <div class="col-span-4 flex items-center">
                                        <mat-button
                                            class="min-w-10 min-h-7 h-7 px-2 leading-6 mr-2"
                                            mat-stroked-button
                                            (click)="toggleDetails(item.id)">
                                            <mat-icon
                                                *ngIf="selectedItem?.id !== item.id"
                                                class="icon-size-5 mr-2"
                                                [svgIcon]="'heroicons_outline:pencil-square'"></mat-icon>
                                            <mat-icon
                                                *ngIf="selectedItem?.id === item.id"
                                                class="icon-size-5 mr-2"
                                                [svgIcon]="'heroicons_outline:arrow-uturn-left'"></mat-icon>
                                        </mat-button>
                                        <span>{{ item.service?.client?.fullName }}</span>
                                    </div>
                                    <div class="col-span-7 self-center flex flex-col">
                                        <span>{{ item.service?.code }} - {{ item.service?.title }}</span>
                                        <span
                                            >{{ item.service?.date | date: 'dd/MM/yyyy' }} -
                                            {{ item.service?.location }}</span
                                        >
                                    </div>
                                    <div class="col-span-1 self-center text-right">
                                        <span>€ {{ item.service.commission | number: '2.2' }}</span>
                                    </div>

                                    <div
                                        *ngIf="selectedItem && selectedItem.id === item.id"
                                        class="mt-3 mb-3 col-span-12 p-3 border rounded-lg bg-yellow-100">
                                        <ng-container>
                                            <div class="grid grid-cols-12 gap-2">
                                                <div class="col-span-4 flex items-center">
                                                    <button
                                                        mat-raised-button
                                                        color="warn"
                                                        (click)="deleteSelectedItem()"
                                                        [matTooltip]="'Common.Delete' | transloco">
                                                        <mat-icon
                                                            [svgIcon]="'heroicons_outline:trash'"
                                                            class="text-red-600 mr-5"></mat-icon>
                                                        Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </ng-container>
                                    </div>
                                </div>
                            </ng-container>
                        </div>

                        <div class="grid grid-cols-12 gap-x-1 mt-16">
                            <!-- Spacer -->
                            <!-- <div class="col-span-12 mt-16"></div> -->

                            <!-- Subtotal -->
                            <div class="col-span-10 self-center font-medium tracking-tight text-secondary">
                                IMPONIBILE
                            </div>
                            <div class="col-span-2 text-right text-lg">€ {{ payment.amount | number: '2.2' }}</div>
                            <div class="col-span-12 my-3 border-b"></div>

                            <!-- Tax -->
                            <div class="col-span-10 self-center font-medium tracking-tight text-secondary">IVA</div>
                            <div class="col-span-2 text-right text-lg">€ {{ payment.vat | number: '2.2' }}</div>
                            <div class="col-span-12 my-3 border-b"></div>

                            <!-- Tax -->
                            <div class="col-span-10 self-center font-medium tracking-tight text-secondary">
                                Ritenuta
                            </div>
                            <div class="col-span-2 text-right text-lg">
                                € {{ payment.withholdingTax | number: '2.2' }}
                            </div>
                            <div class="col-span-12 my-3 border-b"></div>

                            <!-- Total -->
                            <div class="col-span-10 self-center text-2xl font-medium tracking-tight text-secondary">
                                Totale Pagamento
                            </div>
                            <div class="col-span-2 text-right text-2xl font-medium">
                                € {{ payment.total | number: '2.2' }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </mat-drawer-content>
        <mat-drawer
            #drawer
            mode="side"
            position="end"
            [opened]="drawerOpened"
            class="w-120 bg-white dark:bg-gray-900 p-0 border-l flex flex-col h-full min-h-0">
            <!-- Sticky header: title on first row, actions on second row -->
            <div class="sticky top-0 z-20 border-b bg-white dark:bg-gray-900">
                <!-- Title row -->
                <div class="p-3">
                    <h3 class="text-xl font-bold mb-0 ml-2">Servizi</h3>
                </div>

                <!-- Actions row: icons left, Insert on the right -->
                <div class="p-2 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <button mat-icon-button (click)="checkAll()" [matTooltip]="'Common.SelectAll' | transloco">
                            <mat-icon [svgIcon]="'mat_outline:checklist'"></mat-icon>
                        </button>

                        <button mat-icon-button (click)="uncheckAll()" [matTooltip]="'Common.UnselectAll' | transloco">
                            <mat-icon [svgIcon]="'mat_outline:rule'"></mat-icon>
                        </button>

                        <button
                            mat-icon-button
                            (click)="loadServicesToBePaid()"
                            [matTooltip]="'Common.Refresh' | transloco">
                            <mat-icon [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
                        </button>
                    </div>

                    <div class="flex items-center">
                        <button
                            mat-raised-button
                            color="primary"
                            (click)="onInsertSelectedServices()"
                            [disabled]="!hasSelectedServices">
                            Insert
                        </button>
                    </div>
                </div>
            </div>

            <!-- Scrollable list area -->
            <div class="p-4 overflow-y-auto flex-1 h-full">
                <div *ngIf="servicesToBePaid.length > 0; else noServices" class="h-full">
                    <ul class="space-y-2 h-full">
                        <li
                            *ngFor="let service of servicesToBePaid; let i = index"
                            class="p-2 rounded bg-gray-100 dark:bg-gray-800 flex items-center">
                            <mat-checkbox [(ngModel)]="service.selected" class="mr-3"></mat-checkbox>
                            <div class="flex-1">
                                <div class="text-sm">
                                    {{ service.date | date: 'dd/MM/yyyy' }} - {{ service.location }}
                                </div>
                                <div class="font-semibold">
                                    <a [routerLink]="['/service', service?.id]" target="_blank">
                                        {{ service.code }} - {{ service.title }}
                                    </a>
                                </div>
                                <div class="font-semibold">
                                    <a [routerLink]="['/contact', service?.clientId]" target="_blank">
                                        {{ service.client?.fullName }}
                                    </a>
                                </div>
                                <div class="text-sm">Commission: € {{ service.commission | number: '2.2' }}</div>
                            </div>
                        </li>
                    </ul>
                </div>
                <ng-template #noServices>
                    <div class="text-gray-500">Nessun servizio da pagare per questo collaboratore.</div>
                </ng-template>
            </div>
        </mat-drawer>
    </mat-drawer-container>
</div>
